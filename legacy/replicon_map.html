<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf8" />
		<title>test dessin</title>
		<link rel="stylesheet" href="styles/test.css">
		<link rel="stylesheet" href="styles/color.css">
		<script src="lib/jquery-1.10.2.js" type="text/javascript"></script>
		<script src="lib/jquery.mousewheel.js" type="text/javascript"></script>
		<script src="lib/raphael-min.js"></script>
		<!--<script src="http://github.com/DmitryBaranovskiy/raphael/raw/master/raphael-min.js"></script>-->
		<!--<script src="lib/raphael.js"></script>-->
		<!--<script src="lib/popup.js"></script>  -->
		<script src="lib/mustache.min.js"></script>
		<!--<script src="http://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.0/mustache.min.js"></script>-->
		<script id="repl_table_Tpl" type="text/template">
<h2>Replicon</h2>
    <ul>
        {{#replicon}}
        <li>name: {{name}}</li>
        <li>length: {{length}}</li>
        <li>topology: {{topology}}</li> 
        {{/replicon}}
    </ul>
    
    <h3>Genes</h3>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Gene status</th>
                <th>Begin match</th>
                <th>End match</th>
				<th>System</th>
                <th>Score</th>
                <th>Sequence coverage</th>
                <th>Sequence length</th>
                <th>i_eval</th>
                <th>Position</th>
				<th>Profile coverage</th>
				<th>Id</th>
                <th>Match</th>
                
            </tr>
        </thead>
        <tbody>
            {{#genes}}
            <tr>
                <td {{#match}} class="gene_{{match}}"{{/match}}>{{name}}</td>
                <td>{{gene_status}}</td>
				<td>{{begin_match}}</td>
				<td>{{end_match}}</td>
				<td>{{system}}</td>
                <!-- <td>{{strand}}</td> comment sait on sur quel brin est le gene?  beg et end?-->
                <td>{{score}}</td>
				<td>{{sequence_coverage}}</td>
				<td>{{sequence_length}}</td>
				<td>{{i_eval}}</td>
				<td>{{position}}</td>
				<td>{{profile_coverage}}</td>
				<td>{{id}}</td>
                <td>{{match}}</td>
            </tr>
            {{/genes}}
        </tbody>
    </table>
</script>
<script id="gene_info_Tpl" type="text/template">
    <h4>Gene Informations</h4>
          <ul>
                      <li>name: {{name}}</li>
                      <li>match : {{match}}</li>
                      <li>protein length: {{length}}</li>
                      <li>description : {{description}}</li>
                    </ul>
</script>
 </head>
    <body>
    <H1>titre à déterminer</H1>
    <div id="system_schema" class="grabbable">
    </div>
    <div id="replicon_schema" class="grabbable">
    </div>
    <div id="gene_infos">
    fly cursor over a gene to display informations
    </div>
    <div id="genes_table">
    
    </div>
</body>
<script type="text/javascript">
        //if I don't put my script here Rapahael produce an error
        //due to jquery selector which not work 
        //even if I use document.ready  
        
        var Replicon = function Replicon(doc){
            this.length = doc.replicon.length;
            this.topology = doc.replicon.topology;
            this.genes = [];
            var genes_number = doc.genes.length;
            this.all_protein_length = 0;
            for (var i = 0; i < genes_number; i++){
                this.genes[i] = new Gene(this, doc.genes[i]);
                this.all_protein_length = this.all_protein_length + this.genes[i].length
            }
            //drawer need to acces to genes so 
            //it must be created after all genes
            if (this.topology == 'linear'){
                this.drawer = new LinearDrawer(this)
            } else {
                this.drawer = new CircularDrawer(this)
            }
            this.drawing = {};
        }
        
        Replicon.prototype.draw = function draw_replicon(paper){
            if (this.topology == 'linear'){
                var repl_len_in_px = this.drawer.paper_w -(2 * this.drawer.replicon_offset);
                return paper.path(["M, ",this.drawer.replicon_offset, this.drawer.y_replicon, 
                                   "h", repl_len_in_px, "a25,5 -1 0,1 0,5h", 
                                   (-1*(repl_len_in_px)),"a25,5 0 0,1 0,-5z"]).attr({fill: "#aaa", stroke:"#aaa", "stroke-width":"1"} );
            }else{
            	var rep = paper.set()
                var circ = paper.circle(this.drawer.center.x,
                		  this.drawer.center.y,
                		  this.drawer.radius['replicon']).attr({stroke:"#aaa", "stroke-width":"3"} );
                rep.push(circ);
                var ori_coord = this.drawer.pos_2_coord(0,"outer_body");
                var ori = paper.rect(ori_coord[0], 
                	                 ori_coord[1], 
                		             2, 
                		             this.drawer.radius["outer_body"] - this.drawer.radius["inner_body"]).attr({fill: "#aaa", stroke:"#aaa"});
                rep.push(ori);
                return rep
            }
        }
        
 
        var Gene = function Gene(replicon, doc_gene){
            this.replicon = replicon;
            this.paper = replicon.paper
            this.name = doc_gene.name;
            this.position = doc_gene.position;
            this.length = doc_gene.sequence_length;
            //this.strand = doc_gene.strand;
            this.strand = doc_gene.begin_match < doc_gene.end_match ? 'D' : 'C';
            this.match = doc_gene.match;
            //this.drawing = this.draw();
            // est ce qu'il faut aussi une method resize
            // binder sur les evt de resize de la fenetre
            // ou on utilise zoom?
        }
        
        Gene.prototype.draw = function draw_gene(paper){
            var drawer = this.replicon.drawer;
            /*********************************
            *        draw the arrow
            **********************************/
            if(this.strand =='D' ){
            	var body_l = this.length * 3 / 4;
                var pt_0 = drawer.pos_2_coord(this.position,"inner_body");
                var pt_1 = drawer.pos_2_coord(this.position + body_l, "inner_body");
                var pt_2 = drawer.pos_2_coord(this.position + body_l, "inner_head");
                var pt_3 = drawer.pos_2_coord(this.position + this.length, "replicon");
                var pt_4 = drawer.pos_2_coord(this.position + body_l, "outer_head");
                var pt_5 = drawer.pos_2_coord(this.position + body_l, "outer_body");
                var pt_6 = drawer.pos_2_coord(this.position, "outer_body");
                var arrow_path = ["M ", pt_0[0], pt_0[1],
                                  "A", drawer.radius["inner_body"], drawer.radius["inner_body"], pt_1[2], "0,1", pt_1[0], pt_1[1],
                                  "L", pt_2[0], pt_2[1],
                                  "L", pt_3[0], pt_3[1],
                                  "L", pt_4[0], pt_4[1],
                                  "L", pt_5[0], pt_5[1],
                                  "A", drawer.radius["outer_body"], drawer.radius["outer_body"], pt_1[2], "0,0", pt_6[0], pt_6[1],
                                  "Z"
                                  ];
            }else if(this.strand =='C' ){
            	var head_l = this.length / 4;
                var pt_0 = drawer.pos_2_coord(this.position,"replicon");
                var pt_1 = drawer.pos_2_coord(this.position + head_l, "inner_head");
                var pt_2 = drawer.pos_2_coord(this.position + head_l, "inner_body");
                var pt_3 = drawer.pos_2_coord(this.position + this.length, "inner_body");
                var pt_4 = drawer.pos_2_coord(this.position + this.length, "outer_body");
                var pt_5 = drawer.pos_2_coord(this.position + head_l, "outer_body");
                var pt_6 = drawer.pos_2_coord(this.position+ head_l, "outer_head");
                var arrow_path = ["M ", pt_0[0], pt_0[1],
                                  "L", pt_1[0], pt_1[1],
                                  "L", pt_2[0], pt_2[1],
                                  "A", drawer.radius["inner_body"], drawer.radius["inner_body"], pt_3[2], "0,1", pt_3[0], pt_3[1],
                                  "L", pt_4[0], pt_4[1],
                                  "A", drawer.radius["outer_body"], drawer.radius["outer_body"], pt_3[2], "0,0", pt_5[0], pt_5[1],
                                  "L", pt_6[0], pt_6[1],
                                  "Z"
                                  ];
            }else{
                var pt_0 = drawer.pos_2_coord(this.position,"inner_body");
                var pt_1 = drawer.pos_2_coord(this.position + this.length ,"inner_body");
                var pt_2 = drawer.pos_2_coord(this.position + this.length ,"outer_body");
                var pt_3 = drawer.pos_2_coord(this.position ,"outer_body");
                var arrow_path = ["M ", pt_0[0], pt_0[1], 
                		"A", drawer.radius["inner_body"], drawer.radius["inner_body"], pt_1[2], "0,1", pt_1[0], pt_1[1],
                		"L", pt_2[0],pt_2[1],
                		"A", drawer.radius["outer_body"], drawer.radius["outer_body"], pt_1[2], "0,0", pt_3[0], pt_3[1],
                		"Z"];
            }
            var arrow = paper.path(arrow_path);
            if(!this.match){
                arrow.attr({fill: "white", stroke: "black", "stroke-dasharray": "-", "fill-opacity": 0.5});
            }else{
                var color=$(".gene_" + this.match).css( "background-color" );
                arrow.attr({fill: color, stroke: "none", "fill-opacity": 0.9});
            }
            return arrow 
        }
        

        Gene.prototype.show = function show_gene(){
        	var template = $('#gene_info_Tpl').html();
            var html = Mustache.to_html(template, this);
            $('#gene_infos').html(html);
        }

        Gene.prototype.hide = function hide_gene(){
        	$('#gene_infos').html("fly cursor over a gene to display informations");
        }
        
        
        var CircularDrawer = function CircularDrawer(replicon){
            // comment on represente les replicons circulaire
            // mais dont une petite partie du replicon seileument contient des hits
            // circulaire -> partie du graphique vide
            // lineaire -> perd visuellement l'info de la topology
            // si lineaire avec gene sur l'origine ???
            		
            //rapport entre replicon.length en pb et gene.protein_lenght en aa ??
            this.paper_w = screen.width;
            this.paper_h = screen.height;		
            //this.paper_h = 500;
            //this.paper_w = $("#replicon_schema").width();
            this.replicon_l = replicon.length //ne peut pas acceder a replicon grace a une fermeture??
            this.center = { x : this.paper_w / 2,
                            y : this.paper_h / 2 };
            var radius = (500 - 170) / 2;
            console.log("radius = "+ radius);
            this.radius = {
                    "popup" : radius + 25,
                    "inner_body" : radius - 10,
                    "outer_body" : radius + 10,
                    "inner_head" : radius - 20,
                    "outer_head" : radius + 20,
                    "replicon" : radius,
                    } 
        }
        
        CircularDrawer.prototype.pos_2_coord = function(pos, feature_part){
            var angle = 2 * Math.PI * pos / this.replicon_l; //the angle in rad
            var x = this.center.x + this.radius[feature_part] * Math.sin(angle);
            var y = this.center.y - this.radius[feature_part] * Math.cos(angle);
            return [x, y, angle]
        }
        
        var LinearDrawer = function LinearDrawer(replicon){
        	this.paper_w = screen.width;
        	this.paper_h = screen.height;
        	//this.paper_h = 250;
            //this.paper_w = $("#replicon_schema").width();
            this.y_replicon = 55;
            this.replicon_offset = 40;
            this.genes_offset = 20;
            this.first_g_start = replicon.genes[0].start;//ne peut pas acceder a replicon grace a une fermeture??
            var last_gene = replicon.genes[replicon.genes.length - 1];
            this.last_g_end = replicon.genes[last_gene.start] + last_gene.length;   
            this.coef = this.paper_w - (this.replicon_offset + this.genes_offset) * 2 / (this.last_g_end - this.first_g_start);
            this.ord = {
                    "popup" : this.y_replicon - 40,
                    "inner_body" : this.y_replicon + 10,
                    "outer_body" : this.y_replicon - 10,
                    "inner_head" : this.y_replicon + 20,
                    "outer_head" : this.y_replicon - 20,
                    "replicon" : this.y_replicon,
                    }
            this.center = { x : this.paper_w / 2,
                            y : this.y_replicon
                          };
        }
        LinearDrawer.prototype.pos_2_coord = function(pos, feature_part){
            var y = ord[feature_part];
            var x = (pos - first_g_start) * this.coef + replicon_offset + genes_offset;
            return [x, y, null] //null is to keep the same signature of CircularDrawer.pos_2_coord
        }
        
        
        var System = function System(doc){
        	this.mandatory = []
        	this.allowed = []
        	this.forbiden = []
        	var g_classes = ["mandatory","allowed", "forbiden"];
        	for( var i = 0; i < g_classes.length; i++ ){
        		var gene_class = doc.summary[g_classes[i]]
        		for(var key in gene_class){
        			if (gene_class.hasOwnProperty(key)) {
        				var gene = {};
        				gene.name = key;
        				gene.occurence =  gene_class[key];
        				this[g_classes[i]].push(gene);
        			}
        		}
        	}
        	this.drawer = new SytemDrawer(this);
        	this.drawing = {};
        }
        
        var SytemDrawer = function SystemDrawer(sytem){
        	this.paper_h = screen.height;
        	this.paper_w = screen.width;
        	//this.paper_h = 125;
        	//this.paper_w = $("#system_schema").width();
        	this.y_system = 55;
            this.system_offset = 40;
            this.genes_offset = 20;
            this.inter_gene = 10
            this.gene_h = 20
        }
        
        System.prototype.draw = function draw_system(paper){
           //dessiner un axe
           var system_len_in_px = this.drawer.paper_w -(2 * this.drawer.system_offset);
           var system_set = paper.set();
           var trame = paper.path(["M, ",this.drawer.system_offset, this.drawer.y_system,  
                                   "h", system_len_in_px, "a25,5 -1 0,1 0,5h", 
                                   (-1*(system_len_in_px)),"a25,5 0 0,1 0,-5z"]).attr({fill: "#aaa", stroke:"#aaa", "stroke-width":"1"} );
           system_set.push(trame); 
           var gene_nb = this.mandatory.length + this.allowed.length + this.forbiden.length;
           var gene_len_in_px = (system_len_in_px - (gene_nb + 4) * this.drawer.inter_gene) / gene_nb;
           var gene_y = this.drawer.y_system - this.drawer.gene_h / 2;
           var gene_x = 0;
           var g_classes = ["mandatory","allowed", "forbiden"];
           var colors = { "mandatory" : "#88f",
            		       "allowed" : "#0f0",
            		       "forbiden" : "#f00"
            			};
        	for(var c = 0; c < g_classes.length; c++ ){
        		gene_x += this.drawer.inter_gene;
            	for (var i = 0; i < this[g_classes[c]].length; i++){
            		var gene = this[g_classes[c]][i];
            		if (gene_x == 0){
            			gene_x += this.drawer.system_offset ;
            		} else {
            			gene_x += gene_len_in_px + this.drawer.inter_gene;
            		}
            		var color = colors[g_classes[c]];
            		var gene_sch = paper.set();
            		var box = paper.rect(gene_x, gene_y, gene_len_in_px, this.drawer.gene_h).attr({fill: color, stroke:"#000", "stroke-width":"1"});
            		gene_sch.push(box);
            		var occ = paper.text(gene_x + gene_len_in_px/2, this.drawer.y_system, gene.occurence ).attr({font: '12px Helvetica, Arial', fill: "#000"})
            		gene_sch.push(occ);
            		system_set.push(gene_sch);
            	}
        	}
        	return system_set;
        }
        /***************************************
        * Bouchon pour les documents a afficher
        ****************************************/
        
        var c_doc =   {
        	    "replicon": {
        	        //"length": 106,longueur en nb de genes
        	        "length": 50000,
        	        "name": "ACBA010p01", 
        	        "topology": "circular"
        	      }, 
        	      "genes": [
        	        {
        	          "gene_status": "mandatory", 
        	          "end_match": 890, // debut du match en aa
        	          "begin_match": 25, 
        	          "system": "cT4SS", 
        	          "score": 469.2, 
        	          "sequence_coverage": 0.9622222222222222, 
        	          "sequence_length": 900, 
        	          "i_eval": 1.3e-137, 
        	          "position": 48183, 
        	          "profile_coverage": 0.8207847295864263, 
        	          "id": "ACBA010p01_000400", 
        	          "match": "virB4"
        	        }, 
        	        {
        	          "gene_status": "allowed", 
        	          "end_match": 147, 
        	          "begin_match": 69, 
        	          "system": "pT4SSt", 
        	          "score": 34.5, 
        	          "sequence_coverage": 0.39303482587064675, 
        	          "sequence_length": 201, 
        	          "i_eval": 5.8e-06, 
        	          "position": 48192, 
        	          "profile_coverage": 0.5734265734265734, 
        	          "id": "ACBA010p01_000490", 
        	          "match": "T_virB1"
        	        }, 
        	        {
        	          "gene_status": "mandatory", 
        	          "end_match": 1034, 
        	          "begin_match": 1, 
        	          "system": "cT4SS", 
        	          "score": 705.9, 
        	          "sequence_coverage": 0.9582947173308619, 
        	          "sequence_length": 1079, 
        	          "i_eval": 3.5e-209, 
        	          "position": 48210, 
        	          "profile_coverage": 0.9977272727272727, 
        	          "id": "ACBA010p01_000670", 
        	          "match": "MOBF"
        	        }, 
        	        {
        	          "gene_status": "allowed", 
        	          "end_match": 552, 
        	          "begin_match": 337, 
        	          "system": "cT4SS", 
        	          "score": 141.0, 
        	          "sequence_coverage": 0.30422535211267604, 
        	          "sequence_length": 710, 
        	          "i_eval": 1.3e-38, 
        	          "position": 48211, 
        	          "profile_coverage": 0.990990990990991, 
        	          "id": "ACBA010p01_000680", 
        	          "match": "virD4"
        	        }
        	      ], 
        	      "name": "ACBA010p01_cT4SS_1", 
        	      "summary": {
        	        "mandatory": {
        	          "virB4": 1, 
        	          "MOBH": 0, 
        	          "MOBP3": 0, 
        	          "MOBB": 0, 
        	          "MOBC": 0, 
        	          "MOBF": 1, 
        	          "MOBP2": 0, 
        	          "MOBP1": 0, 
        	          "MOBQ": 0, 
        	          "MOBV": 0, 
        	          "MOBT": 0
        	        }, 
        	        "forbiden": {}, 
        	        "state": "single_locus", 
        	        "allowed": {
        	          "I_trbB": 0, 
        	          "T_virB11": 0, 
        	          "I_trbA": 0, 
        	          "T_virB10": 0, 
        	          "I_traM": 0, 
        	          "T_virB9": 0, 
        	          "T_virB8": 0, 
        	          "T_virB6": 0, 
        	          "T_virB5": 0, 
        	          "T_virB3": 0, 
        	          "T_virB2": 0, 
        	          "T_virB1": 1, 
        	          "I_traK": 0, 
        	          "I_traI": 0, 
        	          "I_traO": 0, 
        	          "I_traN": 0, 
        	          "virD4": 1, 
        	          "I_traL": 0, 
        	          "I_traE": 0, 
        	          "I_traY": 0, 
        	          "I_traR": 0, 
        	          "I_traQ": 0, 
        	          "I_traP": 0, 
        	          "I_traW": 0, 
        	          "I_traT": 0
        	        }
        	      }
        	    };
        
        /******************************************************************
         * HTML table creation using mustache templating                  *
         * must be done before raphael otherwise arrow have not any color *
         ******************************************************************/
         var template = $('#repl_table_Tpl').html();
         var table_html = Mustache.to_html(template, c_doc);
         $('#genes_table').html(table_html);
         
         
         /*********************************************
          * replace cursor icon with open/close hand  *
          * when mouse is over interactive part       *
          *********************************************/
         $("#replicon_schema").bind("mousedown" , function( evt ){
             $(this).toggleClass( "grabbing" ).toggleClass( "grabbable" );
         }); 
         $("#replicon_schema").bind("mouseup" , function(){
             $(this).toggleClass( "grabbable" ).toggleClass( "grabbing" );
         });
         
        /******************************
        * replicon and genes creation *
        *******************************/
        var replicon = new Replicon(c_doc);
        
        var replicon_paper = Raphael("replicon_schema", replicon.drawer.paper_w, replicon.drawer.paper_h );
        replicon_paper.canvas.style.backgroundColor = '#F00';
        replicon.drawing.paper = replicon_paper;
        
        var replicon_schema_w = $("#replicon_schema").width();
        var replicon_schema_h = replicon.drawer.paper_h;
        replicon.drawing.schema = replicon.draw(replicon_paper);
        
        //doit on integrer la boucle dans
        //Replicon.draw
        //ou une methode Replicon.draw_gene
        //sur chaque elt on doit binder les evts !!!
        
        for (var i = 0; i < replicon.genes.length; i++ ){
          var g = replicon.genes[i];
          g.arrow = g.draw(replicon_paper);
          g.arrow.mouseover(g.show.bind(g));
          g.arrow.mouseout(g.hide.bind(g));
         }
        
        /*******************
         * system creation *
         *******************/
        var system = new System(c_doc);
        var system_paper = Raphael("system_schema", system.drawer.paper_w, system.drawer.paper_h );
        system.drawing.paper = system_paper;
        
        var system_schema_w = $("#system_schema").width();
        var system_schema_h = system_paper.height;
        system.drawing.schema = system.draw(system_paper);
        
        /***************
        * pan and zoom *
        ****************/
        
        /********************
         * pan and zoom init*
         ********************/
        replicon_paper.setViewBox(
        		(replicon.drawing.paper.width - $("#system_schema").width())/2,
        		(replicon.drawing.paper.height - $("#system_schema").height())/2,
        		$("#system_schema").width(), 
        		500 );
        
        system_paper.setViewBox(0, 0, system_paper.width, system_paper.height);
        var objArray = [replicon, system];
        for(var i = 0; i < objArray.length; i++){
        	var obj = objArray[i];
        	obj.drawing.viewBox = {};
        	obj.drawing.viewBox.X = 0;
        	obj.drawing.viewBox.Y = 0;
        	obj.drawing.viewBox.zoom = 1;
        	obj.drawing.pan = {};
        	obj.drawing.pan.startX = 0;
        	obj.drawing.pan.startY = 0;
        	obj.drawing.pan.mousedown = false;
        }
        replicon.drawing.viewBox.width = replicon_paper.width;
    	replicon.drawing.viewBox.height = replicon_paper.height;
    	system.drawing.viewBox.width = system_paper.width;
    	system.drawing.viewBox.height = system_paper.height;
        
        /***********************
        * pan and zoom helpers *
        ************************/
        var ObjSelector = function ObjSelector(ctx){
        	if(ctx.id == "replicon_schema"){
        		return replicon;
        	}else if(ctx.id == "system_schema"){
        		return system;
        	} else {
        		return false;
        	}
        }
        /***************
         * zoom in/out *
         ***************/
         
         var zoom = function zoom(evt){
        	// event.deltaY = 1 when wheel up and -1 when down 
        	var obj = ObjSelector(this);
        	if(!obj){
        		return false;
        	}
            var factor;
        	if (evt.deltaY < 0) {
            	factor = 0.95;
            } else {
                factor = 1.05;
            }
        	//transform coordinate in page in coordinate relative to the elt
            var coords = { 
        			x: evt.pageX - $(this).offset().left,
            		y: evt.pageY - $(this).offset().top
        			};
            var vb = replicon.drawing.paper._viewBox
            //transform real coordinates into viewbox coordinates before to aplly new zoom
            var x =  obj.drawing.viewBox.X + coords.x / obj.drawing.viewBox.zoom;
            var y =  obj.drawing.viewBox.Y + coords.y / obj.drawing.viewBox.zoom;
            
            var z = ((obj.drawing.viewBox.zoom || 1) * factor) || 1; //to avoid division by 0
            obj.drawing.viewBox.zoom = z;
    	    console.log("zoom = "+ obj.drawing.viewBox.zoom);
    	    console.log("zoom paper.size = "+obj.drawing.paper.width+ "x"+obj.drawing.paper.height);
        	
    	    obj.drawing.viewBox.width =  obj.drawing.paper.width / z;
        	obj.drawing.viewBox.height = obj.drawing.paper.height / z;
        	obj.drawing.viewBox.height = vb[3] / z;
        	obj.drawing.viewBox.X = x - coords.x / z;
        	obj.drawing.viewBox.Y = y - coords.y / z;
        	console.log("zoom VB before = "+replicon.drawing.paper._viewBox);
        	console.log("zoom coords ="+coords.x+"x"+coords.y);
        	console.log("zoom x ="+x+"x"+y);
            obj.drawing.paper.setViewBox(
            		obj.drawing.viewBox.X, 
            		obj.drawing.viewBox.Y, 
            		obj.drawing.viewBox.width, 
            		obj.drawing.viewBox.height);
            console.log("zoom VB after = "+replicon.drawing.paper._viewBox);
         	return false;//prevent to scroll the window
        }
        
        $("#replicon_schema").mousewheel(zoom);
        $("#system_schema").mousewheel(zoom);
        
        /********
         * Pane *
         ********/
        var startRecord = function startRecord(evt){
        	var obj = ObjSelector(this);
        	if(!obj){
        		return false;
        	}
        	obj.drawing.pan.mousedown = true;
            obj.drawing.pan.startX = evt.pageX;
            obj.drawing.pan.startY = evt.pageY;
        }
        $("#replicon_schema").mousedown(startRecord);
        $("#system_schema").mousedown(startRecord);
        
		var doPan = function doPan(evt){
			var obj = ObjSelector(this);
        	if(!obj){
        		return false;
        	}
			if (obj.drawing.pan.mousedown == false) {
                return;
            }
			//compute dx, dy in the document
			obj.drawing.pan.dX = obj.drawing.pan.startX - evt.pageX;
			obj.drawing.pan.dY = obj.drawing.pan.startY - evt.pageY;
           
			var x_factor = obj.drawing.viewBox.width / obj.drawing.paper.width;
            var y_factor = obj.drawing.viewBox.height / obj.drawing.paper.height;
			console.log("pan x_factor = "+x_factor+" y_factor"+y_factor)
            obj.drawing.pan.dX *= x_factor;
            obj.drawing.pan.dY *= x_factor;
            
            obj.drawing.paper.setViewBox(
            		obj.drawing.viewBox.X + obj.drawing.pan.dX,
            		obj.drawing.viewBox.Y + obj.drawing.pan.dY, 
            		obj.drawing.viewBox.width,
            		obj.drawing.viewBox.height);
		}
		$("#replicon_schema").mousemove(doPan);
		$("#system_schema").mousemove(doPan);
         
		var stopRecord = function stopRecord(evt){
			var obj = ObjSelector(this);
        	if(!obj){
        		return false;
        	}
        	obj.drawing.viewBox.X += obj.drawing.pan.dX;
            obj.drawing.viewBox.Y += obj.drawing.pan.dY;
            obj.drawing.pan.mousedown = false;
		}
		$("#replicon_schema").mouseup(stopRecord);
		$("#system_schema").mouseup(stopRecord);
		
          /****************************************
           * resize canvas folowing window resize *
           ****************************************/
           function resizePaper(){
        	   var rep = $("#replicon_schema");
        	   console.log("#replicon_schema "+rep.width()+"x"+rep.height());
        	   console.log("resizePaper VB= "+replicon_paper._viewBox);
        	   
        	   //replicon.drawing.paper.setSize(rep.width(), rep.height());
        	   console.log("resizePaper screen = "+screen.width+"x"+screen.height);
        	   replicon.drawing.paper.setSize(screen.width, screen.height);
        	   //var vb = replicon_paper._viewBox;
        	   /*
        	   replicon.drawing.paper.setViewBox(vb[0], vb[1], rep.width(), rep.height());
        	   replicon.drawing.viewBox.X = vb[0];
        	   replicon.drawing.viewBox.Y = vb[1];
        	   replicon.drawing.viewBox.width = rep.width();
        	   replicon.drawing.viewBox.height = rep.height();
               */
          }
            //resizePaper();
            //$(window).resize(resizePaper);   
        </script>
</html>
