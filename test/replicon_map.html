<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf8" />
		<title>test dessin</title>
		<link rel="stylesheet" href="styles/test.css">
		<link rel="stylesheet" href="styles/color.css">
		<script src="lib/jquery-1.10.2.js" type="text/javascript"></script>
		<script src="lib/jquery.mousewheel.js" type="text/javascript"></script>
		<script src="lib/raphael-min.js"></script>
		<!--<script src="http://github.com/DmitryBaranovskiy/raphael/raw/master/raphael-min.js"></script>-->
		<!--<script src="lib/raphael.js"></script>-->
		<!--<script src="lib/popup.js"></script>  -->
		<script src="lib/mustache.min.js"></script>
		<!--<script src="http://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.0/mustache.min.js"></script>-->
		<script id="repl_table_Tpl" type="text/template">
<h2>Replicon</h2>
    <ul>
        {{#replicon}}
        <li>name: {{name}}</li>
        <li>length: {{length}}</li>
        <li>topology: {{topology}}</li> 
        {{/replicon}}
    </ul>
    
    <h3>Genes</h3>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Gene status</th>
                <th>Begin match</th>
                <th>End match</th>
				<th>System</th>
                <th>Score</th>
                <th>Sequence coverage</th>
                <th>Sequence length</th>
                <th>i_eval</th>
                <th>Position</th>
				<th>Profile coverage</th>
				<th>Id</th>
                <th>Match</th>
                
            </tr>
        </thead>
        <tbody>
            {{#genes}}
            <tr>
                <td {{#match}} class="gene_{{match}}"{{/match}}>{{name}}</td>
                <td>{{gene_status}}</td>
				<td>{{begin_match}}</td>
				<td>{{end_match}}</td>
				<td>{{system}}</td>
                <!-- <td>{{strand}}</td> comment sait on sur quel brin est le gene?  beg et end?-->
                <td>{{score}}</td>
				<td>{{sequence_coverage}}</td>
				<td>{{sequence_length}}</td>
				<td>{{i_eval}}</td>
				<td>{{position}}</td>
				<td>{{profile_coverage}}</td>
				<td>{{id}}</td>
                <td>{{match}}</td>
            </tr>
            {{/genes}}
        </tbody>
    </table>
</script>
<script id="gene_info_Tpl" type="text/template">
    <h4>Gene Informations</h4>
          <ul>
                      <li>name: {{name}}</li>
                      <li>match : {{match}}</li>
                      <li>protein length: {{length}}</li>
                      <li>description : {{description}}</li>
                    </ul>
</script>
 </head>
    <body>
    <H1>titre à déterminer</H1>
    <div id="genes_schema" class="grabbable">
    </div>
    <div id="gene_infos">
    </div>
    <div id="table">
    
    </div>
</body>
     <script type="text/javascript">
        //if I don't put my script here Rapahael produce an error
        //due to jquery selector which not work 
        //even if I use document.ready  
        
        var Replicon = function Replicon(doc){
            this.length = doc.replicon.length;
            this.topology = doc.replicon.topology;
            this.genes = [];
            var genes_number = doc.genes.length;
            this.all_protein_length = 0;
            for (var i = 0; i < genes_number; i++){
                this.genes[i] = new Gene(this, doc.genes[i]);
                this.all_protein_length = this.all_protein_length + this.genes[i].length
            }
            //drawer need to acces to genes so 
            //it must be created after all genes
            if (this.topology == 'linear'){
                this.drawer = new LinearDrawer(this)
            } else {
                this.drawer = new CircularDrawer(this)
            }
            
            //this.drawing = this.draw();
        }
        
        Replicon.prototype.draw = function draw_replicon(paper){
            if (this.topology == 'linear'){
                repl_len_in_px = this.drawer.paper_w -(2 * this.drawer.replicon_offset);
                return paper.path(["M, ",this.drawer.replicon_offset, this.drawer.y_replicon, 
                                   "h", repl_len_in_px, "a25,5 -1 0,1 0,5h", 
                                   (-1*(repl_len_in_px)),"a25,5 0 0,1 0,-5z"]).attr({fill: "#aaa", stroke:"#aaa", "stroke-width":"1"} );
            }else{
            	var rep = paper.set()
                var circ = paper.circle(this.drawer.center.x,
                		  this.drawer.center.y,
                		  this.drawer.radius['replicon']).attr({stroke:"#aaa", "stroke-width":"3"} );
                rep.push(circ);
                var ori_coord = this.drawer.pos_2_coord(0,"outer_body");
                var ori = paper.rect(ori_coord[0], 
                	                 ori_coord[1], 
                		             2, 
                		             this.drawer.radius["outer_body"] - this.drawer.radius["inner_body"]).attr({fill: "#aaa", stroke:"#aaa"});
                rep.push(ori);
                return rep
            }
        }
        
 
        var Gene = function Gene(replicon, doc_gene){
            this.replicon = replicon;
            this.paper = replicon.paper
            this.name = doc_gene.name;
            this.position = doc_gene.position;
            this.length = doc_gene.sequence_length;
            //this.strand = doc_gene.strand;
            this.strand = doc_gene.begin_match < doc_gene.end_match ? 'D' : 'C';
            this.match = doc_gene.match;
            //this.drawing = this.draw();
            // est ce qu'il faut aussi une method resize
            // binder sur les evt de resize de la fenetre
            // ou on utilise zoom?
        }
        
        Gene.prototype.draw = function draw_gene(paper){
            var drawer = this.replicon.drawer;
            /*********************************
            *        draw the arrow
            **********************************/
            if(this.strand =='D' ){
            	var body_l = this.length * 3 / 4;
                var pt_0 = drawer.pos_2_coord(this.position,"inner_body");
                var pt_1 = drawer.pos_2_coord(this.position + body_l, "inner_body");
                var pt_2 = drawer.pos_2_coord(this.position + body_l, "inner_head");
                var pt_3 = drawer.pos_2_coord(this.position + this.length, "replicon");
                var pt_4 = drawer.pos_2_coord(this.position + body_l, "outer_head");
                var pt_5 = drawer.pos_2_coord(this.position + body_l, "outer_body");
                var pt_6 = drawer.pos_2_coord(this.position, "outer_body");
                var arrow_path = ["M ", pt_0[0], pt_0[1],
                                  "A", drawer.radius["inner_body"], drawer.radius["inner_body"], pt_1[2], "0,1", pt_1[0], pt_1[1],
                                  "L", pt_2[0], pt_2[1],
                                  "L", pt_3[0], pt_3[1],
                                  "L", pt_4[0], pt_4[1],
                                  "L", pt_5[0], pt_5[1],
                                  "A", drawer.radius["outer_body"], drawer.radius["outer_body"], pt_1[2], "0,0", pt_6[0], pt_6[1],
                                  "Z"
                                  ];
            }else if(this.strand =='C' ){
            	var head_l = this.length / 4;
                var pt_0 = drawer.pos_2_coord(this.position,"replicon");
                var pt_1 = drawer.pos_2_coord(this.position + head_l, "inner_head");
                var pt_2 = drawer.pos_2_coord(this.position + head_l, "inner_body");
                var pt_3 = drawer.pos_2_coord(this.position + this.length, "inner_body");
                var pt_4 = drawer.pos_2_coord(this.position + this.length, "outer_body");
                var pt_5 = drawer.pos_2_coord(this.position + head_l, "outer_body");
                var pt_6 = drawer.pos_2_coord(this.position+ head_l, "outer_head");
                var arrow_path = ["M ", pt_0[0], pt_0[1],
                                  "L", pt_1[0], pt_1[1],
                                  "L", pt_2[0], pt_2[1],
                                  "A", drawer.radius["inner_body"], drawer.radius["inner_body"], pt_3[2], "0,1", pt_3[0], pt_3[1],
                                  "L", pt_4[0], pt_4[1],
                                  "A", drawer.radius["outer_body"], drawer.radius["outer_body"], pt_3[2], "0,0", pt_5[0], pt_5[1],
                                  "L", pt_6[0], pt_6[1],
                                  "Z"
                                  ];
            }else{
                var pt_0 = drawer.pos_2_coord(this.position,"inner_body");
                var pt_1 = drawer.pos_2_coord(this.position + this.length ,"inner_body");
                var pt_2 = drawer.pos_2_coord(this.position + this.length ,"outer_body");
                var pt_3 = drawer.pos_2_coord(this.position ,"outer_body");
                var arrow_path = ["M ", pt_0[0], pt_0[1], 
                		"A", drawer.radius["inner_body"], drawer.radius["inner_body"], pt_1[2], "0,1", pt_1[0], pt_1[1],
                		"L", pt_2[0],pt_2[1],
                		"A", drawer.radius["outer_body"], drawer.radius["outer_body"], pt_1[2], "0,0", pt_3[0], pt_3[1],
                		"Z"];
            }
            var arrow = paper.path(arrow_path);
            if(!this.match){
                arrow.attr({fill: "white", stroke: "black", "stroke-dasharray": "-", "fill-opacity": 0.5});
            }else{
                var color=$(".gene_" + this.match).css( "background-color" );
                arrow.attr({fill: color, stroke: "none", "fill-opacity": 0.9});
            }
            return arrow 
        }
        

        Gene.prototype.show = function show_gene(){
        	this.drawing["popup"].show();
        	var template = $('#gene_info_Tpl').html();
            var html = Mustache.to_html(template, this);
            $('#gene_infos').html(html);
        }

        Gene.prototype.hide = function hide_gene(){
        	this.drawing["popup"].hide();
        	$('#gene_infos').html("");
        }
        
        
        var CircularDrawer = function CircularDrawer(replicon){
            // comment on represente les replicons circulaire
            // mais dont une petite partie du replicon seileument contient des hits
            // circulaire -> partie du graphique vide
            // lineaire -> perd visuellement l'info de la topology
            // si lineaire avec gene sur l'origine ???
            		
            //rapport entre replicon.length en pb et gene.protein_lenght en aa ??
            		
            this.paper_h = 500;
            this.paper_w = $("#genes_schema").width();
            this.replicon_l = replicon.length //ne peut pas acceder a replicon grace a une fermeture??
            this.center = { x : this.paper_w / 2,
                            y : this.paper_h / 2 };
            var radius = (this.paper_h - 170) / 2;
            this.radius = {
                    "popup" : radius + 25,
                    "inner_body" : radius - 10,
                    "outer_body" : radius + 10,
                    "inner_head" : radius - 20,
                    "outer_head" : radius + 20,
                    "replicon" : radius,
                    } 
        }
        
        CircularDrawer.prototype.pos_2_coord = function(pos, feature_part){
            var angle = 2 * Math.PI * pos / this.replicon_l; //the angle in rad
            var x = this.center.x + this.radius[feature_part] * Math.sin(angle);
            var y = this.center.y - this.radius[feature_part] * Math.cos(angle);
            return [x, y, angle]
        }
        
        var LinearDrawer = function LinearDrawer(replicon){
            this.paper_h = 250;
            this.paper_w = $("#genes_schema").width();
            this.y_replicon = 55;
            this.replicon_offset = 40;
            this.genes_offset = 20;
            this.first_g_start = replicon.genes[0].start;//ne peut pas acceder a replicon grace a une fermeture??
            var last_gene = replicon.genes[replicon.genes.length - 1];
            this.last_g_end = replicon.genes[last_gene.start] + last_gene.length;   
            this.coef = this.paper_w - (this.replicon_offset + this.genes_offset) * 2 / (this.last_g_end - this.first_g_start);
            this.ord = {
                    "popup" : this.y_replicon - 40,
                    "inner_body" : this.y_replicon + 10,
                    "outer_body" : this.y_replicon - 10,
                    "inner_head" : this.y_replicon + 20,
                    "outer_head" : this.y_replicon - 20,
                    "replicon" : this.y_replicon,
                    }
            this.center = { x : this.paper_w / 2,
                            y : this.y_replicon
                          };
        }
        LinearDrawer.prototype.pos_2_coord = function(pos, feature_part){
            var y = ord[feature_part];
            var x = (pos - first_g_start) * this.coef + replicon_offset + genes_offset;
            return [x, y, null] //null is to keep the same signature of CircularDrawer.pos_2_coord
        }
        
        
        
        /***************************************
        * Bouchon pour les documents a afficher
        ****************************************/
        
        var c_doc =   {
        	    "replicon": {
        	        //"length": 106,
        	        "length": 50000,
        	        "name": "ACBA010p01", 
        	        "topology": "circular"
        	      }, 
        	      "genes": [
        	        {
        	          "gene_status": "mandatory", 
        	          "end_match": 890, 
        	          "begin_match": 25, 
        	          "system": "cT4SS", 
        	          "score": 469.2, 
        	          "sequence_coverage": 0.9622222222222222, 
        	          "sequence_length": 900, 
        	          "i_eval": 1.3e-137, 
        	          "position": 48183, 
        	          "profile_coverage": 0.8207847295864263, 
        	          "id": "ACBA010p01_000400", 
        	          "match": "virB4"
        	        }, 
        	        {
        	          "gene_status": "allowed", 
        	          "end_match": 147, 
        	          "begin_match": 69, 
        	          "system": "pT4SSt", 
        	          "score": 34.5, 
        	          "sequence_coverage": 0.39303482587064675, 
        	          "sequence_length": 201, 
        	          "i_eval": 5.8e-06, 
        	          "position": 48192, 
        	          "profile_coverage": 0.5734265734265734, 
        	          "id": "ACBA010p01_000490", 
        	          "match": "T_virB1"
        	        }, 
        	        {
        	          "gene_status": "mandatory", 
        	          "end_match": 1034, 
        	          "begin_match": 1, 
        	          "system": "cT4SS", 
        	          "score": 705.9, 
        	          "sequence_coverage": 0.9582947173308619, 
        	          "sequence_length": 1079, 
        	          "i_eval": 3.5e-209, 
        	          "position": 48210, 
        	          "profile_coverage": 0.9977272727272727, 
        	          "id": "ACBA010p01_000670", 
        	          "match": "MOBF"
        	        }, 
        	        {
        	          "gene_status": "allowed", 
        	          "end_match": 552, 
        	          "begin_match": 337, 
        	          "system": "cT4SS", 
        	          "score": 141.0, 
        	          "sequence_coverage": 0.30422535211267604, 
        	          "sequence_length": 710, 
        	          "i_eval": 1.3e-38, 
        	          "position": 48211, 
        	          "profile_coverage": 0.990990990990991, 
        	          "id": "ACBA010p01_000680", 
        	          "match": "virD4"
        	        }
        	      ], 
        	      "name": "ACBA010p01_cT4SS_1", 
        	      "summary": {
        	        "mandatory": {
        	          "virB4": 1, 
        	          "MOBH": 0, 
        	          "MOBP3": 0, 
        	          "MOBB": 0, 
        	          "MOBC": 0, 
        	          "MOBF": 1, 
        	          "MOBP2": 0, 
        	          "MOBP1": 0, 
        	          "MOBQ": 0, 
        	          "MOBV": 0, 
        	          "MOBT": 0
        	        }, 
        	        "forbiden": {}, 
        	        "state": "single_locus", 
        	        "allowed": {
        	          "I_trbB": 0, 
        	          "T_virB11": 0, 
        	          "I_trbA": 0, 
        	          "T_virB10": 0, 
        	          "I_traM": 0, 
        	          "T_virB9": 0, 
        	          "T_virB8": 0, 
        	          "T_virB6": 0, 
        	          "T_virB5": 0, 
        	          "T_virB3": 0, 
        	          "T_virB2": 0, 
        	          "T_virB1": 1, 
        	          "I_traK": 0, 
        	          "I_traI": 0, 
        	          "I_traO": 0, 
        	          "I_traN": 0, 
        	          "virD4": 1, 
        	          "I_traL": 0, 
        	          "I_traE": 0, 
        	          "I_traY": 0, 
        	          "I_traR": 0, 
        	          "I_traQ": 0, 
        	          "I_traP": 0, 
        	          "I_traW": 0, 
        	          "I_traT": 0
        	        }
        	      }
        	    };
        
        /******************************************************************
         * HTML table creation using mustache templating                  *
         * must be done before raphael otherwise arrow have not any color *
         ******************************************************************/
         var template = $('#repl_table_Tpl').html();
         var table_html = Mustache.to_html(template, c_doc);
         $('#table').html(table_html);
         
         
         /*********************************************
          * replace cursor icon with open/close hand  *
          * when mouse is over interactive part       *
          *********************************************/
         $("#genes_schema").bind("mousedown" , function( evt ){
             $(this).toggleClass( "grabbing" ).toggleClass( "grabbable" );
         }); 
         $("#genes_schema").bind("mouseup" , function(){
             $(this).toggleClass( "grabbable" ).toggleClass( "grabbing" );
         });
         
        /******************************
        * replicon and genes creation *
        *******************************/
        var replicon = new Replicon(c_doc);
        var gene_map = Raphael("genes_schema", replicon.drawer.paper_w, replicon.drawer.paper_h );
        
        var genes_schema_w = $("#genes_schema").width();
        var genes_schema_h = replicon.drawer.paper_h;
        replicon.drawing = replicon.draw(gene_map);
        
        //doit on integrer la boucle dans
        //Replicon.draw
        //ou une methode Replicon.draw_gene
        //sur chaque elt on doit binder les evts !!!
        
        for (var i = 0; i < replicon.genes.length; i++ ){
          g = replicon.genes[i];
          g.arrow = g.draw(gene_map);
          g.arrow.mouseover(g.show.bind(g));
          g.arrow.mouseout(g.hide.bind(g));
         }
        
        
        /***************
        * pan and zoom *
        ****************/
        gene_map.setViewBox(0, 0, gene_map.width, gene_map.height);
        var viewBoxWidth = gene_map.width;
        var viewBoxHeight = gene_map.height;
        var canvasID = "#genes_schema";
        var startX, startY;
        var mousedown = false;
        var dX, dY;
        var oX = 0, oY = 0, oWidth = viewBoxWidth, oHeight = viewBoxHeight;
        var viewBox = gene_map.setViewBox(oX, oY, viewBoxWidth,
                viewBoxHeight);
        viewBox.X = oX;
        viewBox.Y = oY;
        function handle(delta) {
            vBHo = viewBoxHeight;
            vBWo = viewBoxWidth;
            if (delta < 0) {
                viewBoxWidth *= 0.95;
                viewBoxHeight *= 0.95;
            } else {
                viewBoxWidth *= 1.05;
                viewBoxHeight *= 1.05;
            }

            viewBox.X -= (viewBoxWidth - vBWo) / 2;
            viewBox.Y -= (viewBoxHeight - vBHo) / 2;
            gene_map.setViewBox(viewBox.X, viewBox.Y, viewBoxWidth,
                    viewBoxHeight);
        }
        
        /***************
         * zoom in/out *
         ***************/
        $("#genes_schema").mousewheel(function(event){
        	// event.deltaY = 1 when wheel up and -1 when down 
        	var delta = event.deltaY;
        	handle(delta);
        	return false;//prevent to scroll the window
        });
        
        
        /********
         * Pane *
         ********/
        $(canvasID).mousedown(function(e) {

            if (gene_map.getElementByPoint(e.pageX, e.pageY) != null) {
                return;
            }
            mousedown = true;
            startX = e.pageX;
            startY = e.pageY;
        });

        $(canvasID).mousemove(
                function(e) {
                    if (mousedown == false) {
                        return;
                    }
                    dX = startX - e.pageX;
                    dY = startY - e.pageY;
                    x = viewBoxWidth / gene_map.width;
                    y = viewBoxHeight / gene_map.height;

                    dX *= x;
                    dY *= y;
                    //alert(viewBoxWidth +" "+ gene_map.width );

                    gene_map.setViewBox(viewBox.X + dX,
                            viewBox.Y + dY, viewBoxWidth,
                            viewBoxHeight);

                })

        $(canvasID).mouseup(function(e) {
            if (mousedown == false)
                return;
            viewBox.X += dX;
            viewBox.Y += dY;
            mousedown = false;

        });
        
        /****************************************
         * resize canvas folowing window resize *
         ****************************************/
        function resizePaper(){
            var win = $(this);
            var ratioW =  $("#genes_schema").width() / genes_schema_w;
            var ratioH = 1 ;
            //var scale = ratioW < ratioH ? ratioW : ratioH;
            var scale = ratioW;
            //var newHeight = parseInt(old_h * scale);
            var newHeight = genes_schema_h;
            var newWidth = parseInt(genes_schema_w * scale);
            gene_map.setSize(newWidth, newHeight);
          }
          resizePaper();
          $(window).resize(resizePaper); 
          
           
        </script>
</html>
